(()=>{"use strict";async function t(t){const e=new Image;e.src=t,await new Promise(((t,n)=>{e.onload=t,e.onerror=n}));const n=document.createElement("canvas");return n.width=e.width,n.height=e.height,n.getContext("2d").drawImage(e,0,0,n.width,n.height),n}function e(t){try{const e=function(t){const e=atob(t.split(",")[1]),n=t.split(",")[0].split(":")[1].split(";")[0],a=new ArrayBuffer(e.length),r=new Uint8Array(a);for(let t=0;t<e.length;t++)r[t]=e.charCodeAt(t);return new Blob([a],{type:n})}(t.toDataURL("image/png")),n="watermark.png",a=document.createElement("a"),r=window.URL.createObjectURL(e);a.href=r,a.download=n,a.style.display="none",document.body.appendChild(a),a.click(),window.URL.revokeObjectURL(r),document.body.removeChild(a)}catch(t){}}function n(t,e){!function(t){const{watermarkText:e,watermarkColor:n,watermarkSize:a,watermarkFont:r}=t;if(!(e&&n&&a&&r))throw new Error("缺少水印参数")}(e);const n=e?.density||10,a=t.getContext("2d");!function(t,e){t.font=`${e?.watermarkSize}px ${e?.watermarkFont}`,t.fillStyle=e?.watermarkColor,t.textBaseline="middle",t.rotationRadians=e?.rotationRadians||30,t.globalAlpha=e?.watermarkOpacity||.5}(a,e);const{width:r,height:o}=t,i=function(t,e,n){const a=Math.max(t,e),r=Math.floor(a/n),o=[0];for(;o[o.length-1]<a/2;)o.push(o[o.length-1]+r);return[...o,...o.slice(1).map((t=>-t))]}(r,o,n),c=function(t){return{lines:(t?.watermarkText?.split("\n")||[]).slice(0,3),fontSize:t?.watermarkSize,lineSpacing:2}}(e);!function(t,e){const{canvasSize:n,coordinatePoints:a,textConfig:r}=e,{lines:o,fontSize:i,lineSpacing:c}=r,{width:s,height:d}=n;for(let e of a)for(let n of a)t.save(),t.translate(s/2,d/2),t.rotate(Math.PI/180*-t.rotationRadians),o.forEach(((a,r)=>{const o=i*r+c;t.fillText(a,e,n+o)})),t.restore()}(a,{canvasSize:{width:r,height:o},coordinatePoints:i,textConfig:c})}(async()=>{const a=document.getElementById("form"),r=document.getElementById("imageInput"),o=document.getElementById("imageContainer"),i=document.getElementById("previewContainer");let c="";const s={preview:document.getElementById("preview"),download:document.getElementById("download")};let d=null;s.preview.addEventListener("click",(()=>d="preview")),s.download.addEventListener("click",(()=>d="download"));const l=async e=>{try{const{watermarkText:a,watermarkFont:r,watermarkSize:o,watermarkColor:s}=e;if(!c)return;const d=await t(c);n(d,{watermarkText:a,watermarkColor:s,watermarkSize:o,watermarkFont:r,watermarkOpacity:1});const l=function(t){const{width:e,height:n}=t,a=new Image;return a.src=t.toDataURL(),a.style.width=`${e}px`,a.style.height=`${n}px`,a}(d);i.innerHTML="",i.appendChild(l)}catch(t){}};a.addEventListener("submit",(a=>{a.preventDefault();const r=new FormData(a.target),o=Object.fromEntries(r.entries());"preview"===d?l(o):"download"===d&&(async a=>{try{const{watermarkText:r,watermarkFont:o,watermarkSize:i,watermarkColor:s}=a;if(!c)return;const d=await t(c);n(d,{watermarkText:r,watermarkColor:s,watermarkSize:i,watermarkFont:o,watermarkOpacity:1}),e(d)}catch(t){}})(o)})),r.addEventListener("change",(async t=>{const e=t.target.files[0];if(function(t){return!!t&&t.name&&""!==t.name.trim()&&t.size>0}(e)){const t=await function(t){return new Promise(((e,n)=>{const a=new FileReader;a.onload=t=>e(t.target.result),a.onerror=t=>n(t),a.readAsDataURL(t)}))}(e);c=t;const n=new Image;n.src=t,o.innerHTML="",o.appendChild(n)}}))})()})();